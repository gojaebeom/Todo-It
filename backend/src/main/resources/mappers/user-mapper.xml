<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.todoit.api.mapper.UserMapper">
    <resultMap id="user" type="kr.todoit.api.dto.UserDetailResponse">
        <id column="id" property="id"/>
        <result column="user_code" property="userCode"/>
        <result column="nickname" property="nickname"/>
        <result column="email" property="email"/>
        <result column="profile_img" property="profileImg"/>
        <result column="profile_preview_img" property="profilePreviewImg"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>
    <resultMap id="userHash" type="java.util.HashMap">
        <id column="id" property="id"/>
        <result column="user_code" property="userCode"/>
        <result column="nickname" property="nickname"/>
        <result column="email" property="email"/>
        <result column="profile_img" property="profileImg"/>
        <result column="profile_preview_img" property="profilePreviewImg"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>
    <resultMap id="calendarsHash" type="java.util.HashMap">
        <id column="c_id" property="id"/>
        <result column="c_name" property="name"/>
        <result column="is_private" property="isPrivate"/>
        <result column="thumbnail" property="thumbnail"/>
        <result column="thumbnail_preview" property="thumbnailPreview"/>
    </resultMap>

    <resultMap id="detail" type="kr.todoit.api.dto.UserDetailWithCalendarsResponse">
        <id column="id" property="id"/>
        <association property="user" resultMap="userHash"/>
        <collection property="calendars" resultMap="calendarsHash"/>
    </resultMap>
    <select id="findOneWithCalendarsById" parameterType="java.lang.Long" resultMap="detail">
        select
            -- 회원 정보
            u.id, u.user_code, u.nickname, u.email, u.updated_at as created_at, u.profile_img, u.profile_preview_img,
            -- 캘린더 정보
            c.id as c_id, c.name as c_name,
            if(c.is_private = null, c.is_private, 0) as is_private,
            if(c.thumbnail is not null, c.thumbnail, '') as thumbnail,
            if(c.thumbnail_preview is not null, c.thumbnail_preview, '') as thumbnail_preview
        from users u
                 left join calendar_groups cg on u.id = cg.user_id
                 left join calendars c on cg.calendar_id = c.id
        where u.id = #{id};
    </select>

    <select id="findOneById" parameterType="java.lang.Long" resultMap="user">
        select
            -- 회원 정보
            u.id, u.user_code, u.nickname, u.email, u.updated_at as created_at, u.profile_img, u.profile_preview_img
        from users u
        where u.id = #{id}
    </select>
</mapper>